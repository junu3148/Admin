<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="token">

    <insert id="saveRefreshToken" parameterType="map">

        INSERT INTO refresh_tokens (admin_key, refresh_token, expiry_date)
        SELECT admin_key, #{refreshToken}, DATE_ADD(#{expiryDate}, INTERVAL 9 HOUR)
        FROM ADMIN
        WHERE admin_id = #{userName}

    </insert>

    <select id="findRefreshToken" parameterType="String" resultType="RefreshToken">

        SELECT refresh_token,
               expiry_date
        FROM refresh_tokens
        WHERE ADMIN_KEY = (SELECT ADMIN_KEY FROM ADMIN WHERE ADMIN_ID = #{userName})
          AND expiry_date > NOW()

    </select>

</mapper>