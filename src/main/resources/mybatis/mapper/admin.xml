<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="admin">

    <!--로그인 인증-->
    <select id="findByUsername" parameterType="String" resultType="AdminUser">

        SELECT admin_id,
               admin_password
        FROM ADMIN
        WHERE admin_id = #{adminId}

    </select>

    <!--권한정보 조회-->
    <select id="getRole" parameterType="String" resultType="int">

        SELECT role
        FROM ADMIN
        WHERE admin_id = #{adminId}

    </select>

    <!--2차 로그인 adminUser 정보가져오기-->
    <select id="adminLoginCk" parameterType="AdminUser" resultType="AdminUser">

        SELECT admin_key
        FROM ADMIN
        WHERE admin_name = #{adminName}

        <if test="bankName != null and depositor != null and accountNumber != null">

            AND bank_name = #{bankName}
            AND depositor = #{depositor}
            AND account_number = #{accountNumber}

        </if>

    </select>

    <!--AdminUser 정보 가져오기-->
    <select id="getAdminUser" parameterType="AdminUser" resultType="AdminUser">

        SELECT admin_key,
               admin_id,
               admin_password,
               admin_name,
               depositor,
               bank_name,
               account_number,
               role
        FROM ADMIN
        WHERE admin_id = #{adminId}
          AND admin_password = #{adminPassword}

    </select>


    <!--가입자 현황-->
    <select id="subscriberCount" resultType="int">

        SELECT count(admin_key)
        FROM ADMIN

    </select>

    <!--메인페이지 월별가입자 그래프-->
    <select id="getMonthlySubscriber" resultType="java.util.Map">

        SELECT month, subscribers_count
        FROM monthly_subscribers

    </select>

    <!--메인페이지 현황지표-->
    <select id="getUserActivity" resultType="UserActivityDTO">

        SELECT user_count, up_down, percentage
        FROM user_activity

    </select>

    <!--메인페이지 문의현황-->
    <select id="getInquiryList" resultType="InquiryDTO">

        SELECT inquiry_key,
               date_format(inquiry_date, '%Y-%m-%d') AS inquiryDate,
               inquiry_content,
               CASE inquiry_status
                   WHEN 'N' THEN
                       '답변대기'
                   WHEN 'Y' THEN
                       '답변완료'
                   ELSE
                       inquiry_status
                   END                               AS inquiryStatus
        FROM inquiry

    </select>

    <!--가입자 리스트-->
    <select id="getJoinList" parameterType="JoinSearchDTO" resultType="JoinListDTO">

        SELECT user_key,
        user_name AS 고객명,
        user_id AS 이메일,
        phone_number AS 연락처,
        plan_name AS 플랜,
        accession_date AS 가입일,
        withdrawal_date AS 회원탈퇴일,
        occupation AS 직업,
        CASE
        WHEN YEAR(CURDATE()) - birth_year BETWEEN 10 AND 19 THEN '10대'
        WHEN YEAR(CURDATE()) - birth_year BETWEEN 20 AND 29 THEN '20대'
        WHEN YEAR(CURDATE()) - birth_year BETWEEN 30 AND 39 THEN '30대'
        WHEN YEAR(CURDATE()) - birth_year BETWEEN 40 AND 49 THEN '40대'
        WHEN YEAR(CURDATE()) - birth_year BETWEEN 50 AND 59 THEN '50대'
        WHEN YEAR(CURDATE()) - birth_year BETWEEN 60 AND 69 THEN '60대'
        WHEN YEAR(CURDATE()) - birth_year BETWEEN 70 AND 79 THEN '70대'
        WHEN YEAR(CURDATE()) - birth_year BETWEEN 80 AND 89 THEN '80대'
        ELSE '기타'
        END AS 연령,
        gender AS 성별,
        country AS 국가
        FROM USER A
        INNER JOIN PLAN B ON A.plan_key = B.plan_key
        WHERE 1 = 1

        <if test="userName != null and userName != ''">
            AND user_name = #{userName}
        </if>
        <if test="planName != null">
            AND plan_name = #{planName}
        </if>
        <if test="startDate != null and startDate != ''">
            AND accession_date BETWEEN #{startDate} AND #{endDate}
        </if>

    </select>


</mapper>
